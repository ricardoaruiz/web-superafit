<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout">

	<th:block layout:fragment="content">
	
		<div id="principal" class="container">

			<div class="page-header">
			  <h2>Treino<small> do dia</small></h2>
			</div>

			<form id="addTrainning" action="add" method="POST" class="col s12" th:object="${trainning}">
			
				<th:block layout:replace="fragments/messages-form"/>
				<br/>
			
				<div class="row">
					<div class="input-field col s12">
					  <i class="material-icons prefix">subtitles</i>
					  <select id="trainningType" name="trainningType" th:field="*{type}" th:classappend="${#fields.hasErrors('type')} ? invalid">
					    <option value="" selected="true">Selecione o tipo de treinamento</option>
					    <option th:each="tt : ${trainningTypes}" 
					    		th:value="${tt.idSequence}"
					    		th:text="${tt.name}"></option>
					  </select>
					  <label>Tipo de treinamento</label>
					</div>
				</div>
				
				<div class="row">			       
			       <div class="input-field col s12 m6 l6">
			          <i class="material-icons prefix">query_builder</i>
			          <input id="scheduleStart" name="scheduleStart" type="text" class="datepicker" th:field="*{date}" th:classappend="${#fields.hasErrors('date')} ? invalid"/>
			          <label for="scheduleStart">Data do Treino</label>
			       </div>
				   <div class="input-field col s12 m6 l6">
					  <i class="material-icons prefix">subtitles</i>
					  <input type="number" id="rounds" name="rounds" min="0" th:field="*{round}" th:classappend="${#fields.hasErrors('round')} ? invalid"/>					  
					  <label for="rounds">Rounds</label>
					</div>			       
			    </div>	
			    
				<div class="row">
				  <div class="input-field col s12">
				  	<i class="material-icons prefix">subtitles</i>
				    <textarea id="textarea1" class="materialize-textarea" th:field="*{description}"></textarea>
				    <label for="textarea1">Descrição do treino</label>
				  </div>
				</div>			    			

		    	<input type="hidden" id="movementId" name="movementId" th:field="*{movementId}"/>
		    	<input type="hidden" id="movementRepetition" name="movementRepetition" th:field="*{movementRepetition}"/>  										
			
			</form>
			
			<div class="row">
		        <div class="col s12 m6 l12">
		          <div class="card #ff9100 orange accent-2">
		            <div class="card-content white-text">
		              	<span class="card-title">Exercicios</span>
				
						<div class="row">
							<div class="input-field col s12 m6 l6">
							  <i class="material-icons prefix">subtitles</i>
							  <select id="movement" name="movement" class="invalid">
							    <option value="" selected="true">Selecione o exercício</option>
							    <option th:each="m : ${movements}" 
							    		th:value="${m.id}"
							    		th:text="${m.name}"></option>
							  </select>
							  <label style="color : white;" for="movement">Exercício</label>
							</div>
						   <div class="input-field col s12 m6 l6">
							  <i class="material-icons prefix">subtitles</i>
							  <input id="repetition" type="number" min="0"/>
							  <label style="color : white;" for="number">Repetições</label>							  
							</div>					
							
						</div>	
						
						<!-- Aqui tem que ter a tabela que vai sendo alimentada a cada inclusão de treino -->
						<table id="movementTable" class="centered">
							<thead>
  							   <tr>
							      <th>Exercício</th>
							      <th>Repetições</th>
							      <th>Remover</th>
						  		</tr>
							</thead>
							<tbody id="movementsTBody"></tbody>
						</table>
						
						<div class="card-action">
			              <a href="#" onclick="addMovement()" style="color : white;">Adicionar</a>
			            </div>
				
		            </div>
		          </div>
		        </div>
		      </div>			
			
			<br/><br/><br/>
	
			<div class="fixed-action-btn horizontal">
			  <a class="btn-floating btn-large tooltipped tooltipped #ff9100 orange accent-4" data-position="top" data-delay="50" data-tooltip="Ações">
			    <i class="large material-icons">menu</i>
			  </a>
			  <ul>
			    <li><a class="btn-floating waves-effect waves-light tooltipped tooltipped #ff9100 orange accent-4" data-position="top" data-delay="50" data-tooltip="Voltar" href="#"><i class="material-icons">skip_previous</i></a></li>
			    <li><a class="btn-floating waves-effect waves-light tooltipped tooltipped #ff9100 orange accent-4" data-position="top" data-delay="50" data-tooltip="Confirmar" href="#" onclick="submitForm();"><i class="material-icons">done</i></a></li>
			  </ul>
			</div>			

		</div>
	
	</th:block>
</html>
<script>
function loadValues() {
	
	movementId = $('#movementId').val().split(',');
	movementRepetition = $('#movementRepetition').val().split(',');	
	sanitizeArrays();
	
	var index = 0;
	movementId.forEach(function(entry) {		    
	    $("#movement > option").each(function() {
	    	if(entry == this.value) {	    		
	    		var line = '<tr>';
	    		
	    		line += '<td>';
	    		line += this.text;
	    		line += '</td>';
	    		
	    		line += '<td>';
	    		line += movementRepetition[index];
	    		line += '</td>';	
	    		
	    		line += '<td onclick="removeMovement(this);">';
	    		line += '<i class="material-icons sf-link">delete</i>';
	    		line += '</td>';		
	    		
	    		line += '</tr>';
	    				    		
	    		$('#movementsTBody').append(line);		
	    		
	    		index++;
	    	}		        
	    });
	    
	});
		
}

function addMovement() {
	var line = '<tr>';
	
	line += '<td>';
	line += $('#movement option:selected').text();
	line += '</td>';
	
	line += '<td>';
	line += $('#repetition').val();
	line += '</td>';	
	
	line += '<td onclick="removeMovement(this);">';
	line += '<i class="material-icons sf-link">delete</i>';
	line += '</td>';		
	
	line += '</tr>';
	
	movementId.push($('#movement').val());
	movementRepetition.push($('#repetition').val())
	
	$('#movementsTBody').append(line);
	
}
function removeMovement(obj) {
	var indexLine = $(obj).closest('tr').index();	
	movementId.splice(indexLine, 1);
	movementRepetition.splice(indexLine, 1);	
	$(obj).closest('tr').remove();
}
function submitForm() {
	sanitizeArrays();
	
	$('#movementId').val(movementId);
	$('#movementRepetition').val(movementRepetition);
	$('#addTrainning').submit();
}
function sanitizeArrays() {
	if(movementId.length > 1) {
		if(movementId[0] == '') {
			movementId.splice(0,1);
			movementRepetition.splice(0,1);
		}
	}
}

loadValues();
</script>
